# Quick Test - Delete 10 Images

Simple test script to verify the cleanup logic by actually deleting 10 files.

## What This Does

1. Queries 10 products with 3D models updated 7-14 days ago
2. Extracts file paths from `glb_url`
3. Deletes the actual files from Supabase storage using Storage API
4. Updates `glb_url` to `NULL` in database
5. Verifies the cleanup worked

**‚ö†Ô∏è WARNING: This performs REAL deletion! Files cannot be recovered.**

## Prerequisites

```bash
# Install Python dependencies
pip install supabase python-dotenv

# Ensure .env file exists at: supabase/functions/.env
# with SUPABASE_SERVICE_ROLE_KEY
```

## Run the Test

```bash
cd G:\Projects\mcgrocer-project\ai-dashboard\supabase\functions\cleanup-old-3d-models

python test-delete-10.py
```

## Expected Output

```
üß™ Testing 3D Model Cleanup - Delete 10 Files
======================================================================

üìÖ Date Range:
   14 days ago: 2025-10-24T10:37:00.000000
   7 days ago:  2025-10-31T10:37:00.000000

1Ô∏è‚É£  Querying 10 products with 3D models...
   ‚úÖ Found 10 products

2Ô∏è‚É£  Extracting file paths...
   - Product ABC123: 3d-models/uuid-123/file.glb...
   - Product ABC124: 3d-models/uuid-124/file.glb...
   ...
   ‚úÖ Extracted 10 valid paths

‚ö†Ô∏è  WARNING: This will PERMANENTLY delete files!
   Files to delete: 10
   Products to update: 10

Type 'yes' to continue: yes

3Ô∏è‚É£  Deleting files from storage...
   ‚úÖ Successfully deleted 10 files
   - 3d-models/uuid-123/file.glb
   - 3d-models/uuid-124/file.glb
   - 3d-models/uuid-125/file.glb
   ... and 7 more

4Ô∏è‚É£  Updating database (setting glb_url to NULL)...
   ‚úÖ Updated 10 records

5Ô∏è‚É£  Verifying cleanup...
   Database: 10/10 records have NULL glb_url
   ‚úÖ Database verification PASSED

======================================================================
‚úÖ TEST COMPLETED SUCCESSFULLY!

Summary:
   Files deleted:     10
   Records updated:   10
   Verification:      10/10 confirmed

‚úÖ The cleanup logic works! Safe to deploy Edge Function.
```

## If No Products Found

```
1Ô∏è‚É£  Querying 10 products with 3D models...
   ‚ö†Ô∏è  No products found in time window
   This might be expected if no products are 7-14 days old

   Checking total products with glb_url...
   Total products with glb_url: 0
   ‚úÖ Good! No 3D models to clean up
```

This is normal if:
- No products exist in the 7-14 day window
- All 3D models are newer than 7 days
- All 3D models are older than 14 days

## What to Check

### ‚úÖ Success Indicators
- Files deleted count matches products found
- Records updated count matches products found
- Verification shows all glb_url are NULL
- No errors in output

### ‚ùå Failure Indicators
- "Storage deletion failed" error
- "Database update failed" error
- Verification shows mismatched counts
- Exception/traceback

## After Successful Test

If test passes:
1. ‚úÖ The cleanup logic is correct
2. ‚úÖ Storage API deletion works
3. ‚úÖ Database updates work
4. ‚úÖ Safe to deploy Edge Function

Next steps:
```bash
# Deploy the Edge Function
npx supabase functions deploy cleanup-old-3d-models

# Enable cron schedule (weekly on Sunday at 2 AM)
npx supabase functions schedule cleanup-old-3d-models --cron "0 2 * * 0"
```

## Troubleshooting

### "SUPABASE_SERVICE_ROLE_KEY not found"
- Check `.env` file exists at `supabase/functions/.env`
- Ensure key is named `SUPABASE_SERVICE_ROLE_KEY` or `SUPABASE_KEY`
- Key should be service role key, not anon key

### "No products found in time window"
- This is normal if no products are 7-14 days old
- Check when products were last updated in the database
- Consider adjusting time window for testing

### "Storage deletion failed"
- Verify Storage API permissions
- Check file paths are correct
- Ensure service role key has storage access

### "Database update failed"
- Verify database permissions
- Check product IDs are valid
- Ensure service role key has update access

## Rollback

If something goes wrong, 3D models can be regenerated by:
1. Running the weight-dimension agent on affected products
2. Models will be recreated from product images
